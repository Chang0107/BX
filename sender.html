<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹å¼ A: ç‰©å“åµæ¸¬ (LANç‰ˆ)</title>
    <!-- å¼•å…¥ Socket.io å®¢æˆ¶ç«¯ -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // å¦‚æœç„¡æ³•è¼‰å…¥ï¼Œå˜—è©¦ CDN
        if (typeof io === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"><\/script>');
        }
    </script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f0f4f8; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; text-align: center; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; color: white; transition: 0.3s; }
        .btn-send { background-color: #3498db; }
        .btn-send:hover { background-color: #2980b9; }
        
        .auto-mode { margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #e67e22; }
        input:checked + .slider:before { transform: translateX(26px); }

        .status { margin-top: 15px; padding: 10px; background: #e8f6f3; color: #27ae60; text-align: center; border-radius: 4px; font-size: 14px; }
        .log { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; font-size: 12px; color: #666; height: 150px; overflow-y: auto; }
        .status-disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <h2>ç¨‹å¼ A (å€åŸŸç¶²è·¯ç‰ˆ)</h2>
    
    <div class="status" id="connectionStatus">
        ğŸŸ¡ é€£ç·šä¸­...
    </div>

    <div class="form-group">
        <label>ç‰©å“åç¨±:</label>
        <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šè˜‹æœ" value="è˜‹æœ">
    </div>

    <div class="form-group">
        <label>æ•¸é‡:</label>
        <input type="number" id="itemQty" value="1" min="1">
    </div>

    <button class="btn-send" onclick="sendItem(false)">å–®æ¬¡ç™¼é€ (æ‰‹å‹•)</button>

    <div class="auto-mode">
        <span style="font-weight:bold; color:#856404;">æ¨¡æ“¬æŒçºŒåµæ¸¬ (æ¯1.5ç§’)</span>
        <label class="switch">
            <input type="checkbox" id="autoToggle" onchange="toggleAutoMode()">
            <span class="slider"></span>
        </label>
    </div>

    <div class="log" id="logArea">
        <div>ç³»çµ±å•Ÿå‹•...</div>
    </div>
</div>

    <script>
        // è‡ªå‹•é€£ç·šåˆ°ä¼ºæœå™¨
        const SERVER_URL = window.location.origin;
        
        let socket;
        if (typeof io !== 'undefined') {
            socket = io(SERVER_URL);
        } else {
            alert("ç„¡æ³•è¼‰å…¥ Socket.io å‡½å¼åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ä¼ºæœå™¨ IP è¨­å®šã€‚");
        }
    
    let autoInterval = null;

    const statusDiv = document.getElementById('connectionStatus');

    // é€£ç·šç‹€æ…‹ç›£è½
    socket.on('connect', () => {
        statusDiv.innerHTML = "ğŸŸ¢ å·²é€£ç·šåˆ°ä¼ºæœå™¨";
        statusDiv.className = "status";
    });

    socket.on('disconnect', () => {
        statusDiv.innerHTML = "ğŸ”´ èˆ‡ä¼ºæœå™¨æ–·ç·š";
        statusDiv.className = "status status-disconnected";
        // æ–·ç·šæ™‚è‡ªå‹•åœæ­¢æŒçºŒåµæ¸¬
        if (document.getElementById('autoToggle').checked) {
            document.getElementById('autoToggle').checked = false;
            toggleAutoMode();
        }
    });

    // æ¥æ”¶ä¼ºæœå™¨å›å‚³çš„æ“ä½œçµæœ (Log)
    socket.on('log_response', (data) => {
        const { name, action } = data;
        if (action === 'DUPLICATE') {
            log(`[å¿½ç•¥] ${name} (åµæ¸¬ä¸­é‡è¤‡è¨Šè™Ÿ)`);
        } else if (action === 'ADD' || action === 'NEW') {
            log(`[ç™¼é€æˆåŠŸ] ${name} å·²æ›´æ–°`);
        }
    });

    function log(message) {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString();
        logArea.innerHTML = `<div>[${time}] ${message}</div>` + logArea.innerHTML;
    }

    function sendItem(isAutoMode) {
        const nameInput = document.getElementById('itemName');
        const qtyInput = document.getElementById('itemQty');
        
        const name = nameInput.value.trim();
        const qty = parseInt(qtyInput.value);

        if (!name || qty <= 0) {
            if (!isAutoMode) alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åç¨±èˆ‡æ•¸é‡");
            return;
        }

        // ç™¼é€çµ¦ä¼ºæœå™¨
        socket.emit('detect_item', {
            name: name,
            quantity: qty,
            isAutoMode: isAutoMode
        });

        if (!isAutoMode) {
            log(`[æ‰‹å‹•] é€å‡ºè«‹æ±‚: ${name}`);
        }
    }

    function toggleAutoMode() {
        const isChecked = document.getElementById('autoToggle').checked;

        if (isChecked) {
            if (!socket.connected) {
                alert("å°šæœªé€£ç·šåˆ°ä¼ºæœå™¨ï¼Œç„¡æ³•é–‹å•Ÿ");
                document.getElementById('autoToggle').checked = false;
                return;
            }
            log("é–‹å•ŸæŒçºŒåµæ¸¬...");
            statusDiv.innerHTML = "ğŸŸ  æŒçºŒåµæ¸¬ä¸­ (æ¨¡æ“¬æ„Ÿæ¸¬å™¨)";
            
            sendItem(true);
            autoInterval = setInterval(() => {
                sendItem(true);
            }, 1500);
        } else {
            log("åœæ­¢æŒçºŒåµæ¸¬");
            if (socket.connected) {
                statusDiv.innerHTML = "ğŸŸ¢ å·²é€£ç·šåˆ°ä¼ºæœå™¨";
            }
            clearInterval(autoInterval);
            autoInterval = null;
        }
    }
</script>

</body>
</html>