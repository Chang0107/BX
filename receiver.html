<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹å¼ B: åº«å­˜ç®¡ç† (LANåŒæ­¥ç‰ˆ)</title>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        if (typeof io === 'undefined') {
            document.write('<script src="/socket.io/socket.io.js"><\/script>');
        }
    </script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f0f4f8; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        
        .status-container { display: flex; gap: 10px; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; transition: 0.3s; }
        .status-online { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-offline { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #555; }
        
        tr.detecting-row {
            background-color: #e8f5e9 !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        input.edit-input { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        .actions button { margin-right: 5px; padding: 5px 10px; cursor: pointer; border: none; border-radius: 3px; color: white; }
        .btn-delete { background-color: #e74c3c; }
        .btn-save { background-color: #27ae60; }
        
        .btn-group-bottom { display: flex; gap: 10px; margin-top: 10px; }
        .btn-clear { flex: 1; background-color: #e74c3c; padding: 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-clean-zero { flex: 1; background-color: #f39c12; padding: 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        
        .manual-add { margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 5px; border: 1px dashed #ccc; }
        .manual-add h3 { margin-top: 0; font-size: 16px; }
        .flex-row { display: flex; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ç¨‹å¼ B (å¤šè£ç½®åŒæ­¥ç‰ˆ)</h2>
        <div class="status-container">
            <div id="detectorStatus" class="status-badge status-offline">ğŸ“· åµæ¸¬ç«¯: é›¢ç·š</div>
            <div id="serverStatus" class="status-badge status-offline">ğŸŒ ä¼ºæœå™¨: é€£ç·šä¸­...</div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>ä¾†æº</th>
                <th>ç‰©å“åç¨±</th>
                <th>æ•¸é‡</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="inventoryList">
        </tbody>
    </table>
    
    <div class="btn-group-bottom">
        <button class="btn-clean-zero" onclick="cleanZeroItems()">ğŸ§¹ æ¸…é™¤æ•¸é‡ç‚º 0 çš„é …ç›®</button>
        <button class="btn-clear" onclick="smartReset()">âš ï¸ æ™ºæ…§é‡ç½® (ä¾ç›®å‰ç•«é¢)</button>
    </div>

    <div class="manual-add">
        <h3>â• æ‰‹å‹•æ–°å¢ç‰©å“</h3>
        <div class="flex-row">
            <input type="text" id="manualName" placeholder="ç‰©å“åç¨±" class="edit-input" style="width: 200px;">
            <input type="number" id="manualQty" placeholder="æ•¸é‡" class="edit-input">
            <button class="btn-save" onclick="addManualItem()">æ–°å¢</button>
        </div>
    </div>
</div>

    <script>
        const SERVER_URL = window.location.origin;
        let socket;
        if (typeof io !== 'undefined') {
            socket = io(SERVER_URL);
        } else {
            alert("ç„¡æ³•è¼‰å…¥ Socket.ioï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨é€£ç·šã€‚");
        }

    let inventory = [];

    // --- é€£ç·šç®¡ç† ---
    socket.on('connect', () => {
        updateServerStatus(true);
    });

    socket.on('disconnect', () => {
        updateServerStatus(false);
        updateDetectorStatus(false); // Server æ–·äº†ï¼Œåµæ¸¬ç«¯è‚¯å®šä¹Ÿé€£ä¸ä¸Š
    });
    
    // ç›£è½åµæ¸¬ç«¯ç‹€æ…‹
    socket.on('detector_status', (isConnected) => {
        const wasOffline = document.getElementById('detectorStatus').classList.contains('status-offline');
        
        updateDetectorStatus(isConnected);
        
        // å¦‚æœåµæ¸¬ç«¯å¾é›¢ç·šè®Šç‚ºåœ¨ç·š (é‡é€£)ï¼Œè‡ªå‹•è§¸ç™¼æ™ºæ…§é‡ç½®
        if (isConnected && wasOffline) {
            console.log("åµæ¸¬ç«¯é‡æ–°é€£ç·šï¼Œè‡ªå‹•è§¸ç™¼æ™ºæ…§é‡ç½®...");
            
            // ç‚ºäº†é¿å…å¤ªå¿«è§¸ç™¼å°è‡´ç‹€æ…‹ä¸ç©©ï¼Œå»¶é²ä¸€å°æ®µæ™‚é–“
            setTimeout(() => {
                // ä¸å½ˆå‡ºç¢ºèªè¦–çª—ï¼Œç›´æ¥åŸ·è¡Œ
                socket.emit('smart_reset', []); 
                
                // é¡¯ç¤ºé€šçŸ¥
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.backgroundColor = '#27ae60';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '5px';
                notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                notification.style.zIndex = '9999';
                notification.textContent = 'ğŸ“· åµæ¸¬ç«¯å·²é‡é€£ï¼Œè‡ªå‹•åŒæ­¥ç•«é¢ç‰©å“...';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    setTimeout(() => document.body.removeChild(notification), 500);
                }, 3000);
            }, 500);
        }
    });

    function updateServerStatus(online) {
        const div = document.getElementById('serverStatus');
        if (online) {
            div.textContent = "ğŸŒ ä¼ºæœå™¨: ç·šä¸Š";
            div.className = "status-badge status-online";
        } else {
            div.textContent = "ğŸŒ ä¼ºæœå™¨: é›¢ç·š";
            div.className = "status-badge status-offline";
        }
    }
    
    function updateDetectorStatus(online) {
        const div = document.getElementById('detectorStatus');
        if (online) {
            div.textContent = "ğŸ“· åµæ¸¬ç«¯: ç·šä¸Š";
            div.className = "status-badge status-online";
        } else {
            div.textContent = "ğŸ“· åµæ¸¬ç«¯: é›¢ç·š";
            div.className = "status-badge status-offline";
        }
    }

    // --- æ¥æ”¶è³‡æ–™åŒæ­¥ ---
    socket.on('init_data', (data) => {
        inventory = data.inventory;
        updateDetectorStatus(data.isDetectorConnected);
        renderTable();
    });

    socket.on('update_data', (data) => {
        inventory = data;
        renderTable();
    });

    // --- æ“ä½œé‚è¼¯ ---
    function sendUpdate() {
        socket.emit('manual_update', inventory);
    }

    function addManualItem() {
        const name = document.getElementById('manualName').value;
        const qty = parseInt(document.getElementById('manualQty').value);

        if(name && qty > 0) {
            const existing = inventory.find(i => i.name === name);
            if(existing) {
                existing.quantity += qty;
                existing.lastUpdated = Date.now();
            } else {
                inventory.push({
                    id: Date.now(),
                    name: name,
                    quantity: qty,
                    source: 'Bç«¯æ–°å¢',
                    lastUpdated: Date.now(),
                    isDetecting: false,
                    isEditing: false
                });
            }
            sendUpdate();
            document.getElementById('manualName').value = '';
            document.getElementById('manualQty').value = '';
        }
    }

    function deleteItem(id) {
        if(confirm('ç¢ºå®šåˆªé™¤?')) {
            inventory = inventory.filter(item => item.id !== id);
            sendUpdate();
        }
    }
    
    // [æ–°å¢] æ¸…é™¤æ•¸é‡ç‚º 0
    function cleanZeroItems() {
        socket.emit('clean_zero');
    }
    
    // [ä¿®æ”¹] æ™ºæ…§é‡ç½®
    function smartReset() {
        const msg = "ã€æ™ºæ…§é‡ç½®èªªæ˜ã€‘\n\n1. è‹¥åµæ¸¬ç«¯ (PC.py) é€£ç·šä¸­ï¼š\n   å°‡æ¸…ç©ºç¾æœ‰è³‡æ–™ï¼Œä¸¦è¦æ±‚åµæ¸¬ç«¯é‡æ–°ç™¼é€ç›®å‰ç•«é¢ä¸Šçš„ç‰©å“ã€‚\n\n2. è‹¥åµæ¸¬ç«¯é›¢ç·šï¼š\n   å°‡ç›´æ¥æ¸…ç©ºæ‰€æœ‰è³‡æ–™ã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ";
        if(confirm(msg)) {
            // é€™è£¡ä¸éœ€è¦å‚³é€ currentActiveItemsï¼Œå› ç‚ºé‚è¼¯æ”¹åœ¨ Server ç«¯è™•ç†
            // Server æœƒé€šçŸ¥ PC.py é‡é€
            socket.emit('smart_reset', []); 
        }
    }

    function toggleEdit(id) {
        const item = inventory.find(i => i.id === id);
        if (item) {
            item.isEditing = !item.isEditing;
            renderTable();
        }
    }

    function saveEdit(id) {
        const item = inventory.find(i => i.id === id);
        if (item) {
            const nameInput = document.querySelector(`.edit-name-${id}`).value;
            const qtyInput = document.querySelector(`.edit-qty-${id}`).value;
            
            item.name = nameInput;
            item.quantity = parseInt(qtyInput);
            item.isEditing = false;
            sendUpdate();
        }
    }

    function renderTable() {
        const tbody = document.getElementById('inventoryList');
        tbody.innerHTML = '';

        inventory.forEach(item => {
            const tr = document.createElement('tr');
            
            if (item.isDetecting) {
                tr.classList.add('detecting-row');
            }

            const statusText = item.isDetecting ? 
                '<span style="color:#27ae60; font-weight:bold;">âš¡ åµæ¸¬ä¸­...</span>' : 
                '<span style="color:#95a5a6;">éœæ­¢</span>';
            
            if (item.isEditing) {
                tr.innerHTML = `
                    <td><small>${item.source}</small></td>
                    <td><input type="text" class="edit-input edit-name-${item.id}" value="${item.name}"></td>
                    <td><input type="number" class="edit-input edit-qty-${item.id}" value="${item.quantity}"></td>
                    <td>ç·¨è¼¯ä¸­</td>
                    <td class="actions">
                        <button class="btn-save" onclick="saveEdit(${item.id})">å„²å­˜</button>
                    </td>
                `;
            } else {
                tr.innerHTML = `
                    <td><small style="color: #888;">${item.source}</small></td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${statusText}</td>
                    <td class="actions">
                        <button style="background:#f39c12" onclick="toggleEdit(${item.id})">ä¿®æ”¹</button>
                        <button class="btn-delete" onclick="deleteItem(${item.id})">åˆªé™¤</button>
                    </td>
                `;
            }
            tbody.appendChild(tr);
        });
    }
</script>

</body>
</html>